<div class="container">
  <h3 class="title-form"><%= "#{@trip.name}" %></h3>
  <div class="header flex justify-content-between align-items-center">
    <p class="subtitle-form"><strong><%= "Entrez vos disponibilités pour les semaines du mois de #{Date::MONTHNAMES[@trip.month]} et proposez la prochaine destination !" %></strong></p>
    <section>
      <input type="text" id="codemob" value="<%= "http://localhost:3000/trips/#{@trip.id}/trip_availabilities/new" %>" readonly>
      <button class="button-orange" data-copytarget="#codemob">Copier</b>
    </section>
  </div>
  <div class="swiper">
    <div class="swiper-wrapper">
      <div class="swiper-slide">
        <div class="form flex">
          <div class="content flex">
            <div class="flex header-name">
              <div class="name"></div>
              <div class="flex">
                <% if !(Subscription.where(user: current_user, trip: @trip).first) %>
                  <div class="card-avatar names">
                    <%= image_tag "https://kitt.lewagon.com/placeholder/users/#{current_user.ghname}", class:"avatar"  %>
                    <p class="first-name"><%= current_user.username.capitalize %></p>
                    <div class="check"></div>
                  </div>
                <% end %>
                <% @trip.subscriptions.each do |sub| %>
                  <div class="card-avatar names">
                    <%= image_tag "https://kitt.lewagon.com/placeholder/users/#{sub.user.ghname}", class:"avatar"  %>
                    <p class="first-name"><%= sub.user.username.capitalize %></p>
                    <div class="check">
                      <% c = 0 %>
                      <% TripAvailability.where(trip_id: @trip.id).each do |ta| %>
                        <% if Availability.where(user_id: sub.user.id, trip_availability_id: ta.id).first && c == 0 %>
                          <% c += 1 %>
                          <i class="fas fa-check"></i>
                        <% end %>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
            <% @trip_availabilities.each_with_index do |ta, index| %>
              <div class="flex ta">
                <div class="flex week">
                  <p>Semaine <%= index + 1 %></p>
                  <p><%= "#{ta.start_at.day} - #{ta.end_at.day} #{Date::MONTHNAMES[ta.start_at.month]}" %></p>
                </div>
                <% if !(Subscription.where(user: current_user, trip: @trip).first) %>
                  <div class="flex av">
                    <div class="flex" data-controller="availabilities" data-availabilities-target="container">
                      <%= render "add_button", trip_av: ta %>
                    </div>
                  </div>
                <% end %>
                <% @trip.subscriptions.each do |sub| %>
                  <div class="flex av">
                    <% av = Availability.where(user_id: sub.user.id, trip_availability_id: ta.id).first %>
                    <% if av %>
                      <% if current_user == sub.user %>
                        <div class="flex" data-controller="availabilities" data-availabilities-target="container">
                          <%= render "remove_button", trip_av: ta, av: av %>
                        </div>
                      <% else %>
                        <p class="button-blue-xl-none">Dispo</p>
                      <% end %>
                    <% else %>
                      <% if current_user == sub.user %>
                        <div class="flex" data-controller="availabilities" data-availabilities-target="container">
                          <%= render "add_button", trip_av: ta %>
                        </div>
                      <% else %>
                        <p class="button-blank"></p>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
                <% if current_user.id == @trip.user_id %>
                  <%= link_to "BOOKER", book_trip_path(@trip, trip_av: ta), method: :patch, class: "button-orange-xl" %>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      <div class="swiper-slide">
        <div class="place-proposal">
          <%= simple_form_for([@trip, @place_proposal]) do |f| %>
            <div class="category-wrapper text-center">
              <input type="hidden" name="place_proposal[place_id]" value="">
              <% Place.all.each do |place| %>
                <div class="category-item">
                  <input class="form-check-input radio_buttons required category-selector" type="radio" value="<%= place.id %>" name="place_proposal[place_id]" id="place_proposal_place_id_<%= place.id %>">
                  <label class="form-check-label collection_radio_buttons" style="background-image: url('<%= cl_image_path place.photo.key, crop: :fill, height: 400 %>'); background-size: cover; background-repeat: no-repeat)" for="place_proposal_place_id_<%= place.id %>"><%= place.city %></label>
                </div>
              <% end %>
            </div>
            <div class="text-center">
              <%= f.submit "Valider", id: "validate-button", class: "button-orange-xxl mt-4" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    <div class="swiper-button-next button-orange-xxl">Suivant</div>
    <div class="swiper-button-prev button-grey-xxl">Précédent</div>
  </div>

  <script>
    (function() {
      'use strict';
      document.body.addEventListener('click', copy, true);
      function copy(e) {
        var
          t = e.target,
          c = t.dataset.copytarget,
          inp = (c ? document.querySelector(c) : null);
        if (inp && inp.select) {
          inp.select();
          try {
            document.execCommand('copy');
            inp.focus();
            t.classList.add('copied');
            setTimeout(function() { t.classList.remove('copied'); }, 2500);
          }
          catch (err) {
            alert('Une erreur est survenue. Faites un CTRL+C pour copier le code promo ou clique droit puis "copier".');
          }
        }
      }
    })();
  </script>
</div>
